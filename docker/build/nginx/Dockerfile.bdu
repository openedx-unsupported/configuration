FROM us.icr.io/skills-network-portals/xenial-common:0.1.0-i.2

COPY . /edx/app/edx_ansible/edx_ansible

WORKDIR /edx/app/edx_ansible/edx_ansible/docker/plays
RUN /edx/app/edx_ansible/venvs/edx_ansible/bin/ansible-playbook \
      nginx.yml \
      -i '127.0.0.1,' -c local \
      -e@roles/edxapp/defaults/main.yml \
      -e@roles/forum/defaults/main.yml \
      -e@/edx/app/edx_ansible/edx_ansible/docker/build/nginx/vars/build.yml \
      -e@/edx/app/edx_ansible/edx_ansible/docker/build/nginx/vars/run.yml \
      -t "install:base,install:system-requirements,install:configuration"

# make nginx log to STDOUT and STDERR
RUN ln -sf /dev/stdout /edx/var/log/nginx/access.log && \
    ln -sf /dev/stderr /edx/var/log/nginx/error.log

WORKDIR /edx/app

EXPOSE 18000 48000 18010 48010 18020

ENTRYPOINT ["/edx/app/edx_ansible/edx_ansible/docker/build/nginx/docker-entrypoint.sh"]
CMD ["/usr/sbin/nginx", "-g", "daemon off;"]
