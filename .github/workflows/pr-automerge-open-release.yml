# For non-draft changes to Named Release branches:
# - Always tag community-engineering (for now).
# - Check if the user belongs to a maintainers team.
# - If so, approve the pull request.
#   - If it also has '[automerge]' in the PR body,
#     label it as 'automerge', then merge it.
# Required organization secrets
# - CC_GITHUB_TOKEN=...
# - CC_TEAM_CHAMPIONS=org/team-name
# - CC_TEAM_CHAMPIONS_PEOPLE_ARRAY=["username1"]
# - CC_TEAM_CONTRIBUTORS_ORG=org
# - CC_TEAM_CONTRIBUTORS_TEAM=team-name
---
name: automerge BTR open-release PRs
on:
  issue_comment:
    branches:
    - open-release/*.master
    types:
    - created
    - edited
  pull_request_target:
    branches:
    - open-release/*.master
    types:
    - opened
    - edited
    - ready_for_review
jobs:
  automerge:
    if: ${{ (github.event.issue.pull_request && !github.event.issue.pull_request.draft) || (github.event.pull_request && !github.event.pull_request.draft) }}
    runs-on: ubuntu-latest
    steps:
    - run: echo "${{ toJSON(github) }}"
    - name: lookup teams
      id: teams
      uses: tspascoal/get-user-teams-membership@v1
      with:
        username: "${{ github.actor }}"
        organization: ${{ secrets.CC_TEAM_CONTRIBUTORS_ORG }}
        team: ${{ secrets.CC_TEAM_CONTRIBUTORS_TEAM }}
        GITHUB_TOKEN: "${{ secrets.CC_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}"
    - name: tag team on all Named Release PRs
      if: ${{ github.event.action == 'opened' || github.event.action == 'ready_for_review' }}
      run: |
        curl \
          -X POST \
          -H 'Accept: application/vnd.github.v3+json' \
          -H "authorization: Bearer ${{ secrets.CC_GITHUB_TOKEN || secrets.GITHUB_TOKEN }}" \
          https://api.github.com/repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/requested_reviewers \
          -d '{"reviewers": ${{ secrets.CC_TEAM_CHAMPIONS_PEOPLE_ARRAY }}}' \
        ;
    - name: debug
      run: echo "${{ toJSON(steps.teams) }}"
    - name: approve PR
      if: ${{ steps.teams.outputs.isTeamMember == 'true' && (github.event.action == 'opened' || github.event.action == 'ready_for_review') }}
      uses: andrewmusgrave/automatic-pull-request-review@0.0.5
      with:
        repo-token: ${{ secrets.GITHUB_TOKEN }}
        event: APPROVE
        body: |
          :+1:

          When you're ready to merge, edit the PR description and add this to it: `[automerge]`;
          we'll handle the rest.
          CC: @${{ secrets.CC_TEAM_CHAMPIONS }}
    - name: label PR as auto-mergeable
      if: ${{ steps.teams.outputs.isTeamMember == 'true' && contains(github.event.pull_request.body, '[automerge]') }}
      uses: andymckay/labeler@978f846c4ca6299fd136f465b42c5e87aca28cac
      with:
        add-labels: 'automerge'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    - name: label PR as auto-mergeable
      if: ${{ steps.teams.outputs.isTeamMember == 'true' && contains(github.event.comment.body, '[automerge]') }}
      uses: andymckay/labeler@978f846c4ca6299fd136f465b42c5e87aca28cac
      with:
        add-labels: 'automerge'
        repo-token: ${{ secrets.GITHUB_TOKEN }}
    - name: automerge
      uses: "pascalgn/automerge-action@v0.13.1"
      env:
        GITHUB_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        MERGE_COMMIT_MESSAGE: |
          merge: PR #{pullRequest.number}: {pullRequest.title}
 
          {pullRequest.body}
