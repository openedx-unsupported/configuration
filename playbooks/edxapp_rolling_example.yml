# ansible-playbook -v --user=ubuntu  edxapp_rolling_example.yml -i ./ec2.py  --private-key=/path/to/deployment.pem 

- hosts: tag_Group_anothermulti
  serial: 1
  vars_files:
    - ["{{ secure_file_dir }}/edxapp_stage_vars.yml", "vars/secure_default/edxapp_stage_vars.yml"]
    - ["{{ secure_file_dir }}/users.yml", "vars/secure_default/users.yml"]
    - ["{{ secure_file_dir }}/edxapp_stage_users.yml", "vars/secure_default/edxapp_stage_users.yml"]
  pre_tasks:
    - name: Gathering ec2 facts 
      ec2_facts: 
    - name: Gathering ELB facts
      local_action: ec2_elb_facts
# These two modules "ec2_facts" and "ec2_elb_facts" are invoked in the 
# pre_tasks and give us the $elbs and $ansible_ec2_isntance_id facts 
# which are variables that can be used in the playbook
    - local_action: command util/elb_reg.py -e {{ ",".join(elbs[ansible_ec2_instance_id]) }} -i {{ ansible_ec2_instance_id }} deregister
# -e is the list of elbs that the current instances belong to and -i is 
# the instance "active_elbs" are the elbs that are passed in.
  roles:
    - common
    - nginx 
    - lms
    - ruby
  post_tasks:
    - local_action: command util/elb_reg.py -e {{ ",".join(elbs[ansible_ec2_instance_id]) }} -i {{ ansible_ec2_instance_id }} register
# Register will pass in the same elb list and the same instance id 
# to add it back to the pool

