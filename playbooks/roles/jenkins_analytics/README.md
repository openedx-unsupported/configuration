Jenkins Analytics
=================

A role that sets-up Jenkins for deploying analytics stack on AWS EMR.

This role performs following steps:

* Installs Jenkins using `jenkins_master`
* Configures `config.xml` to enable security and use
  Linux Auth Domain.
* Enable the use of jenkins clis
* Installs a seed job from configured repository, launches it and waits
  for it to finish.

Configuration
-------------

Following variables are used by this role:

You need to provide a json file containing credentials to be uploaded to server.
This  file is **a local file** suitable for use in `copy` module.
The following variable specifies the location of this file:

    jenkins_credentials_file:  ansible-jenkins-credentials.json

Variables used by command waiting on Jenkins start-up after running
`jenkins_master` role:

    jenkins_connection_retries: 60
    jenkins_connection_delay: 0.5

### Auth realm

Jenkins auth realm, that is a method used by jenkins to authenticate users.
Realm type stored in `jenkins_auth_realm.name` variable.

In future we will try enable other auth domains, while
preserving ability to run cli.

#### Unix Realm

For now only `unix` realm supported -- which requires every user to have a
shell account on the server.

Unix realm requires following settings:

* `service`: Jenkins uses PAM configuration for this service. `su` is
a safe choice as it doesn't require a user to have the ability to login
remotely.
* `plain_password`:  plaintext password, **you should change** default values.

* `crypted_password`: encrypted password, to obtain it use `mkpasswd`
command, for example: ` mkpasswd --method=sha-512`.

Example realm configuration:

    jenkins_auth_realm:
      name: unix
      service: su
      plain_password: jenkins
      crypted_password: $6$rAVyI.p2wXVDKk5w$y0G1MQehmHtvaPgdtbrnvAsBqYQ99g939vxrdLXtPQCh/e7GJVwbnqIKZpve8EcMLTtq.7sZwTBYV9Tdjgf1k.


### Seed job configuration

Seed job is configured in `jenkins_seed_job` variable, which has following
attributes:

* `name`:  Name of the job in Jenkins.
* `time_trigger`: A Jenkins cron entry defining how often this job is ran.
* `removed_job_action`: what to do when job created by the seed job is deleted.
  This can be either  `DELETE` or`IGNORE`.
* `removed_view_action`: What to do when view created by the seed job is removed.
  This can be either  `DELETE` or`IGNORE`.
* `scm` Scm object is used to define seed job repository and related settings.
  It has following properties:
  * `scm.type`: It must have value of `git`.
  * `scm.url`: URL for the repository.
  * `scm.credential_id`: Id of credential used to authenticate to the repository.
  * `scm.target_jobs`: A shell glob expression relative to repo selecting
    jobs to import.
  * `scm.additional_classpath`: A path relative to repo root, pointing to a
     directory that contains additional groovy scripts used by the seed jobs.

Example scm configuration:

    jenkins_seed_job:
      name: seed
      time_trigger: "H * * * *"
      removed_job_action: "DELETE"
      removed_view_action: "IGNORE"
      scm:
        type: git
        url: "git@github.com:edx-ops/edx-jenkins-job-dsl.git"
        credential_id: "github-deploy-key"
        targed_jobs: "jobs/analytics-edx-jenkins.edx.org/*Jobs.groovy"
        additional_classpath: "src/main/groovy"

Credential file example
-----------------------

To generate a proper json credential file I strongly suggest:

1. Write the file in `yaml` format.
2. Convert it by using for example:

        cat file.yaml |  python -c "import yaml,json,sys; print(json.dumps(yaml.load(sys.stdin)))" > file.json

Example credential file is here (in `yaml` format):

    # An example list of credentials to send to server
    # Note for some reason ssh keys without passwords dont work.

    credentials:
      # id is a scope-unique credential identifier
      - id: test-password
        # Scope must be global, to have other scopes you'll need ot modify addCredentials.groovy
        scope: GLOBAL
        # Username associated with this password
        username: jbzdak
        type: username-password
        description: Autogenerated by ansible
        password: 'foobarbaz'
      # id is a scope-unique credential identifier
      - id: github-deploy-key
        scope: GLOBAL
        # Username this ssh-key is attached to
        username: jbzdak
        # Type of credential, see other entries for example
        type: ssh-private-key
        # Passphrase, ssh keys don't work without passphrase
        passphrase: 'foobar'
        description: Autogenerated by ansible
        privatekey: |
          -----BEGIN RSA PRIVATE KEY-----
          Proc-Type: 4,ENCRYPTED
          DEK-Info: AES-128-CBC,....

          Key conents
          -----END RSA PRIVATE KEY-----

Known issues
------------

1. SSH keys without password don't work.
2. Playbook named `_execute_ansible_cli.yaml`, should be converted to a
   Ansible module (it is already used in a module-ish way),
3. Anonymous user has discover and get job permission, as without it
  `get-job`, `build <<job>>` commands wouldn't work.
  Giving anonymous these permissions is a workaround for
  transient Jenkins issue (reported [couple][1] [of][2] [times][3]).
4. We force unix authentication method -- that is every user that can login
  to Jenkins also needs to have a shell account on master.


Dependencies
------------

- `jenkins_master`

[1]: https://issues.jenkins-ci.org/browse/JENKINS-12543
[2]: https://issues.jenkins-ci.org/browse/JENKINS-11024
[3]: https://issues.jenkins-ci.org/browse/JENKINS-22143
