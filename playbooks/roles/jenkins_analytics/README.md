# Jenkins Analytics

A role that sets up Jenkins for scheduling analytics tasks.

This role performs the following steps:

* Installs Jenkins using `jenkins_master`.
* Configures `config.xml` to enable security and use
  Linux Auth Domain.
* Creates Jenkins credentials.
* Enables the use of Jenkins CLI.
* Installs a seed job from configured repository, launches it and waits
  for it to finish.

## Configuration

When you are using vagrant you **need** to set `VAGRANT_JENKINS_LOCAL_VARS_FILE`
environment variable. This variable must point to a file containing
all required variables from this section.

This file needs to contain, at least, the following variables
(see the next few sections for more information about them):

* `JENKINS_ANALYTICS_USER_PASSWORD_CRYPTED`
* `JENKINS_ANALYTICS_USER_PASSWORD_PLAIN`
* `JENKINS_ANALYTICS_GITHUB_KEY` or `JENKINS_ANALYTICS_CREDENTIALS`

#### Seed job configuration

To configure the Analytics Schedule Seed Job, override these variables:

* `ANALYTICS_SCHEDULE_EXTRA_VARS`: Optional configuration for the analytics
  schedule top-level seed job.  Can be explicit YML or a file path (e.g.
  `@path/to/file.yml`).  Relative paths are relative to the seed job workspace.

  Default is `@{{ ANALYTICS_SCHEDULE_SECURE_REPO_DEST }}/vars.yml`.
  See **Analytics Task configuration** below for details.
* `ANALYTICS_SCHEDULE_SECURE_REPO_URL`: Optional URL for the git repo that contains the
  `analytics-secure-configuration`.
* `ANALYTICS_SCHEDULE_SECURE_REPO_VERSION`: Optional branch/tagname to checkout
  for the secure repo.  Default is "master".
* `ANALYTICS_SCHEDULE_SECURE_REPO_DEST`: Optional target dir for the the secure
  repo clone.  Default is `analytics-secure-config`.
* `ANALYTICS_SCHEDULE_SECURE_REPO_CREDENTIAL_ID`: Credential id with read
  access to the secure repo.  Optional if the secure repo isn't private.
  See *Jenkins credentials* below for details.
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_URL`: Optional URL for the git repo that contains the analytics job DSLs.
  Default is `git@github.com:edx/edx-jenkins-job-dsl.git`
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_VERSION`: Optional branch/tagname to checkout for the analytics job DSLs.
  Default is `master`.
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_CREDENTIAL_ID`: Credential id with read access to the job DSL repo.
  Optional if the job DSL repo is public.
  See *Jenkins credentials* below for details.
* `ANALYTICS_SCHEDULE_JOBS_DSL_CLASSPATH`: Optional additional classpath jars and folders for the job DSLs.
  Must be newline-separated.
  Default is:

        src/main/groovy
        lib/*.jar

* `ANALYTICS_SCHEDULE_JOBS_DSL_TARGET_JOBS`: DSLs for the top-level seed job to run on build.
  Default is `jobs/analytics-edx-jenkins.edx.org/*Jobs.groovy`

#### Analytics task configuration

`ANALYTICS_SCHEDULE_EXTRA_VARS` is used to configure the actual analytics
tasks which are generated by the Analytics Schedule seed job.  It contains the
configuration for each individual analytics task.  Currently supported
analytics tasks are:

* `ANSWER_DISTRIBUTION`: invokes
  `edx.analytics.tasks.answer_dist.AnswerDistributionWorkflow` via the
  `answerDist.groovy` DSL.
* `IMPORT_ENROLLMENTS_INTO_MYSQL`: invokes
  `edx.analytics.tasks.enrollments.ImportEnrollmentsIntoMysql` via the
  `importEnrol.groovy` DSL.
* `COURSE_ACTIVITY_WEEKLY`: invokes
  `edx.analytics.tasks.user_activity.CourseActivityWeeklyTask` via the
  `courseActivity.groovy` DSL.
* `INSERT_TO_MYSQL_ALL_VIDEO`: invokes
  `edx.analytics.tasks.video.InsertToMysqlAllVideoTask` via the
  `insertAllVideo.groovy` DSL.
* `INSERT_TO_MYSQL_COURSE_ENROLL_BY_COUNTRY:` invokes
  `edx.analytics.tasks.location_per_course.InsertToMysqlCourseEnrollByCountryWorkflow` via the
  `courseEnrollByCountry.groovy` DSL.


The Analytics Tasks configuration should contain the following variables, where
`<TASK_NAME>` is the name of the task to configure:

* `ANALYTICS_SCHEDULE_<TASK_NAME>`:  `true`|`false`.  Must be set to `true` to create the analytics task.
* `ANALYTICS_SCHEDULE_<TASK_NAME>_FREQUENCY`: Optional string representing how
  often the analytics task should be run.  Uses a modified cron syntax, e.g.
  `@daily`, `@weekly`, see [stackoverflow](http://stackoverflow.com/a/12472740)
  for details.
  Default is different for each analytics task.
* `ANALYTICS_SCHEDULE_<TASK_NAME>_EXTRA_VARS`: YML config or @file location to
  override the analytics task parameters.
  The list of parameters will differ for each analytics task, but examples
  include:

          TASKS_REPO: "https://github.com/open-craft/edx-analytics-pipeline.git"
          TASKS_BRANCH: "analytics-sandbox"
          CONFIG_REPO: "https://github.com/open-craft/edx-analytics-configuration.git"
          CONFIG_BRANCH: "analytics-sandbox"
          ENVIRONMENT: "analytics-sandbox"
          EXTRA_VARS: "@/home/jenkins/emr-vars.yml"
          CREDENTIAL_ID: "github-deploy-key"

#### Jenkins user password

You'll need to override default jenkins user password, please do that
as this sets up the **shell** password for this user.

You'll need to set both plain password and hashed one,
to obtain hashed password use `mkpasswd` command, for example:
`mkpasswd --method=sha-512`. (Note: hashed password is required
to have clean "changed"/"unchanged" notification for this step
in Ansible.)

* `JENKINS_ANALYTICS_USER_PASSWORD_HASHED`: hashed password
* `JENKINS_ANALYTICS_USER_PASSWORD_PLAIN`: plain password

#### Jenkins credentials

Jenkins contains its own credential store, to fill it with credentials
please use `JENKINS_ANALYTICS_CREDENTIALS` variable. This variable
is a list of objects, each object represents a single credential,
for now passwords and ssh-keys are supported.

If you only need credentials to access github repositories
you can override `JENKINS_ANALYTICS_GITHUB_KEY`,
which should contain contents of private key used for
authentication to checkout github repositories.

Each credential has an unique id, this credential id is used by
Jenkins jobs to match a task requiring credential with a
credential for given task.

Examples of credentials variables:

    JENKINS_ANALYTICS_GITHUB_KEY: "{{ lookup('file', 'path to keyfile') }}"

    JENKINS_ANALYTICS_CREDENTIALS:
      # id is a scope-unique credential identifier
      - id: test-password
        # Scope must be global, to have other scopes you'll need ot modify addCredentials.groovy
        scope: GLOBAL
        # Username associated with this password
        username: jenkins
        type: username-password
        description: Autogenerated by ansible
        password: 'foobarbaz'
      # id is a scope-unique credential identifier
      - id: github-deploy-key
        scope: GLOBAL
        # Username this ssh-key is attached to
        username: git
        # Type of credential, see other entries for example
        type: ssh-private-key
        passphrase: 'foobar'
        description: Generated by ansible
        privatekey: |
          -----BEGIN RSA PRIVATE KEY-----
          Proc-Type: 4,ENCRYPTED
          DEK-Info: AES-128-CBC,....

          Key contents
          -----END RSA PRIVATE KEY-----

### General configuration

Following variables are used by this role:

Variables used by command waiting on Jenkins start-up after running
`jenkins_master` role:

    jenkins_connection_retries: 60
    jenkins_connection_delay: 0.5

#### Auth realm

Jenkins auth realm, that is a method used by jenkins to authenticate users.
Realm type stored in `jenkins_auth_realm.name` variable.

In future we will try enable other auth domains, while
preserving ability to run cli.

##### Unix Realm

For now only `unix` realm supported -- which requires every user to have a
shell account on the server.

Unix realm requires following settings:

* `service`: Jenkins uses PAM configuration for this service. `su` is
a safe choice as it doesn't require a user to have the ability to login
remotely.
* `plain_password`:  plaintext password, **you should change** default values.
* `hashed_password`: hashed password

Example realm configuration:

    jenkins_auth_realm:
      name: unix
      service: su
      plain_password: jenkins
      hashed_password: $6$rAVyI.p2wXVDKk5w$y0G1MQehmHtvaPgdtbrnvAsBqYQ99g939vxrdLXtPQCh/e7GJVwbnqIKZpve8EcMLTtq.7sZwTBYV9Tdjgf1k.


Known issues
------------

1. Playbook named `_execute_ansible_cli.yaml`, should be converted to a
   Ansible module (it is already used in a module-ish way),
2. Anonymous user has discover and get job permission, as without it
   `get-job`, `build <<job>>` commands wouldn't work.
   Giving anonymous these permissions is a workaround for
   transient Jenkins issue (reported [couple][1] [of][2] [times][3]).
3. We force unix authentication method -- that is every user that can login
   to Jenkins also needs to have a shell account on master.


Dependencies
------------

- `jenkins_master`

[1]: https://issues.jenkins-ci.org/browse/JENKINS-12543
[2]: https://issues.jenkins-ci.org/browse/JENKINS-11024
[3]: https://issues.jenkins-ci.org/browse/JENKINS-22143
