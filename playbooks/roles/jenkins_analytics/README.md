# Jenkins Analytics

A role that sets up Jenkins for scheduling analytics tasks.

This role performs the following steps:

* Installs Jenkins using `jenkins_master`.
* Configures `config.xml` to enable security and use
  Linux Auth Domain.
* Creates Jenkins credentials.
* Enables the use of Jenkins CLI.
* Installs a seed job from configured repository, launches it and waits
  for it to finish.

## Configuration

When you are using vagrant you **need** to set `VAGRANT_JENKINS_LOCAL_VARS_FILE`
environment variable. This variable must point to a file containing
all required variables from this section.

This file needs to contain, at least, the following variables:

* `JENKINS_ANALYTICS_USER_PASSWORD_HASHED` and `JENKINS_ANALYTICS_USER_PASSWORD_PLAIN`.  See [Jenkins User Password](#jenkins-user-password) for details.
* `JENKINS_ANALYTICS_GITHUB_KEY` or `JENKINS_ANALYTICS_CREDENTIALS`.  See [Jenkins Credentials](#jenkins-credentials) for details.
* `ANALYTICS_SCHEDULE_EXTRA_VARS` and/or `ANALYTICS_SCHEDULE_SECURE_REPO_*`.  See [Seed Job Configuration](#seed-job-configuration) for details.

#### Jenkins User Password

You'll need to override default jenkins user password, please do that
as this sets up the **shell** password for this user, and is also used to
authenticate the jenkins user in the web interface.

You'll need to set both plain password and hashed one,
to obtain hashed password use `mkpasswd` command, for example:
`mkpasswd --method=sha-512`. (Note: since `mkpasswd` generates a different hash
each time, the hashed password is required to have clean "changed"/"unchanged"
notification for this step in Ansible.)

* `JENKINS_ANALYTICS_USER_PASSWORD_HASHED`: hashed password
* `JENKINS_ANALYTICS_USER_PASSWORD_PLAIN`: plain password

#### Jenkins Credentials

Jenkins contains its own credential store, to fill it with credentials
please use `JENKINS_ANALYTICS_CREDENTIALS` variable. This variable
is a list of objects, each object represents a single credential,
for now passwords and ssh-keys are supported. 

If you only need credentials to access github repositories
you can override `JENKINS_ANALYTICS_GITHUB_KEY`,
which should contain contents of private key used for
authentication to checkout github repositories.

Each credential has an unique id, this credential id is used by
Jenkins jobs to match a task requiring credential with a
credential for given task.

`JENKINS_ANALYTICS_GITHUB_CREDENTIAL_ID` is used to identify the github repo
credential, and it is used as the default value for
`ANALYTICS_SCHEDULE_SECURE_REPO_CREDENTIAL_ID` and
`ANALYTICS_SCHEDULE_JOBS_DSL_REPO_CREDENTIAL_ID`.  Its default is:

    JENKINS_ANALYTICS_GITHUB_CREDENTIAL_ID: "github-deploy-key"

Examples of credentials variables:

    JENKINS_ANALYTICS_GITHUB_KEY: "{{ lookup('file', 'path to keyfile') }}"

    JENKINS_ANALYTICS_CREDENTIALS:
      # id is a scope-unique credential identifier
      - id: test-password
        # Scope must be global, to have other scopes you'll need ot modify addCredentials.groovy
        scope: GLOBAL
        # Username associated with this password
        username: jenkins
        type: username-password
        description: Autogenerated by ansible
        password: 'foobarbaz'
      # id is a scope-unique credential identifier
      - id: "{{ JENKINS_ANALYTICS_GITHUB_CREDENTIAL_ID }}"
        scope: GLOBAL
        # Username this ssh-key is attached to
        username: git
        # Type of credential, see other entries for example
        type: ssh-private-key
        passphrase: 'foobar'
        description: Generated by ansible
        privatekey: |
          -----BEGIN RSA PRIVATE KEY-----
          Proc-Type: 4,ENCRYPTED
          DEK-Info: AES-128-CBC,....

          Key contents
          -----END RSA PRIVATE KEY-----

#### Seed Job Configuration

The seed job creates the Analytics Jobs that will run the analytics tasks.  By
default, the seed job will not create any Analytics Jobs, but you can enable
these jobs, and set their parameters, using `ANALYTICS_SCHEDULE_EXTRA_VARS`.

`ANALYTICS_SCHEDULE_EXTRA_VARS` is used to enable and configure the analytics
tasks which are created by the seed job.  `ANALYTICS_SCHEDULE_EXTRA_VARS` may
contain the explicit YAML configuration, or it may contain a path to the file
which contains that configuration.  See [Analytics Task
Configuration](#analytics-task-configuration) below for details on what should
be in `ANALYTICS_SCHEDULE_EXTRA_VARS`.

Since some analytics task configuration values may be confidential, one
convention is to store the `ANALYTICS_SCHEDULE_EXTRA_VARS` in a file in a
secure repo, which is then cloned when running the seed job.  To use a secure
repo, override `ANALYTICS_SCHEDULE_SECURE_REPO_*`, and set
`ANALYTICS_SCHEDULE_EXTRA_VARS` to point to the appropriate file in the secure
repo.

For example:

    ANALYTICS_SCHEDULE_SECURE_REPO_URL: "git@github.com:open-craft/analytics-sandbox-private.git"
    ANALYTICS_SCHEDULE_SECURE_REPO_VERSION: "customer-analytics-schedule"
    ANALYTICS_SCHEDULE_EXTRA_VARS: "@{{ ANALYTICS_SCHEDULE_SECURE_REPO_DEST }}/analytics-pipeline-vars.yml"

The seed job also clones a second repo, which contains the DSL scripts that
encapsulate the analytics tasks themselves.  That repo is configured using
`ANALYTICS_SCHEDULE_JOBS_DSL_REPO_*`, and it will be cloned directly into the
seed job workspace (*not* to a designated `DEST` folder).

**Note:** There are two ways to specify a ssl-based github repo URL.  Note the
subtle difference in the paths: `github.com:your-org` vs. `github.com/your-org`.

* git@github.com:your-org/private-repo.git ✓ 
* ssh://git@github.com/your-org/private-repo.git ✓ 

*Not like this:*

* git@github.com/your-org/private-repo.git ❌ 
* ssh://git@github.com:your-org/private-repo.git ❌ 

The full list of seed job configuration variables is:

* `ANALYTICS_SCHEDULE_EXTRA_VARS`: configuration for the analytics
  schedule top-level seed job.  Can be explicit YML or a file path (e.g.
  `@path/to/file.yml`).  Relative paths are relative to the seed job workspace.

  Default is `@{{ ANALYTICS_SCHEDULE_SECURE_REPO_DEST }}/vars.yml`.
  See [Analytics Task Configuration](#analytics-task-configuration) below for details 
  on what can be configured here.
* `ANALYTICS_SCHEDULE_SECURE_REPO_URL`: Optional URL for the git repo that contains the
  analytics task schedule configuration file.  If set, Jenkins will clone this
  repo when the seed job is run.  Default is `null`.
* `ANALYTICS_SCHEDULE_SECURE_REPO_VERSION`: Optional branch/tagname to checkout
  for the secure repo.  Default is `master`.
* `ANALYTICS_SCHEDULE_SECURE_REPO_DEST`: Optional target dir for the the secure
  repo clone, relative to the seed job workspace.  Default is `analytics-secure-config`.
* `ANALYTICS_SCHEDULE_SECURE_REPO_CREDENTIAL_ID`: Credential id with read
  access to the secure repo.  Default is `{{ JENKINS_ANALYTICS_GITHUB_CREDENTIAL_ID }}`.
  See [Jenkins Credentials](#jenkins-credentials) below for details.
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_URL`: Optional URL for the git repo that contains the analytics job DSLs.
  Default is `git@github.com:edx-ops/edx-jenkins-job-dsl.git`.
  This repo is cloned directly into the seed job workspace.
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_VERSION`: Optional branch/tagname to checkout for the job DSL repo.
  Default is `master`.
* `ANALYTICS_SCHEDULE_JOBS_DSL_REPO_CREDENTIAL_ID`: Credential id with read access to the job DSL repo.
  Default is `{{ JENKINS_ANALYTICS_GITHUB_CREDENTIAL_ID }}`.
  See [Jenkins Credentials](#jenkins-credentials) below for details.
* `ANALYTICS_SCHEDULE_JOBS_DSL_CLASSPATH`: Optional additional classpath jars
  and dirs required to run the job DSLs.
  Each path must be newline-separated, and relative to the seed job workspace.
  Default is:

        src/main/groovy
        lib/*.jar

* `ANALYTICS_SCHEDULE_JOBS_DSL_TARGET_JOBS`: DSLs for the top-level seed job to run on build.
  Default is `jobs/analytics-edx-jenkins.edx.org/*Jobs.groovy`

#### Analytics Task Configuration

Currently supported analytics tasks are:

* `ANSWER_DISTRIBUTION`: invokes
  `edx.analytics.tasks.answer_dist.AnswerDistributionWorkflow` via the
  `answerDist.groovy` DSL.
* `IMPORT_ENROLLMENTS_INTO_MYSQL`: invokes
  `edx.analytics.tasks.enrollments.ImportEnrollmentsIntoMysql` via the
  `importEnrol.groovy` DSL.
* `COURSE_ACTIVITY_WEEKLY`: invokes
  `edx.analytics.tasks.user_activity.CourseActivityWeeklyTask` via the
  `courseActivity.groovy` DSL.
* `INSERT_TO_MYSQL_ALL_VIDEO`: invokes
  `edx.analytics.tasks.video.InsertToMysqlAllVideoTask` via the
  `insertAllVideo.groovy` DSL.
* `INSERT_TO_MYSQL_COURSE_ENROLL_BY_COUNTRY:` invokes
  `edx.analytics.tasks.location_per_course.InsertToMysqlCourseEnrollByCountryWorkflow` via the
  `courseEnrollByCountry.groovy` DSL.

`ANALYTICS_SCHEDULE_EXTRA_VARS` should contain the following variables, for each
`<TASK_NAME>` to be scheduled:

* `ANALYTICS_SCHEDULE_<TASK_NAME>`:  `true`|`false`.  Must be set to `true` to create the analytics task.
* `ANALYTICS_SCHEDULE_<TASK_NAME>_FREQUENCY`: Optional string representing how
  often the analytics task should be run.  Uses a modified cron syntax, e.g.
  `@daily`, `@weekly`, see [stackoverflow](http://stackoverflow.com/a/12472740)
  for details.
  Default is different for each analytics task.
* `ANALYTICS_SCHEDULE_<TASK_NAME>_EXTRA_VARS`: YML config or @file location to
  override the analytics task parameters.
  Consult the individual analytics task DSL for details on the options, but
  examples include:

        TASKS_REPO: "https://github.com/edx/edx-analytics-pipeline.git"
        TASKS_BRANCH: "analytics-sandbox"
        CONFIG_REPO: "https://github.com/edx/edx-analytics-configuration.git"
        CONFIG_BRANCH: "customer-configuration"
        ENVIRONMENT: "analytics-sandbox"
        FROM_DATE: "2016-01-01"
        EXTRA_VARS: "@/home/jenkins/emr-vars.yml"

For example:

        ANALYTICS_SCHEDULE_ANSWER_DISTRIBUTION: true
        ANALYTICS_SCHEDULE_ANSWER_DISTRIBUTION_FREQUENCY: "@weekly"
        ANALYTICS_SCHEDULE_ANSWER_DISTRIBUTION_EXTRA_VARS: "@path/to/answer_dist_defaults.yml"

        ANALYTICS_SCHEDULE_IMPORT_ENROLLMENTS_INTO_MYSQL: true
        ANALYTICS_SCHEDULE_IMPORT_ENROLLMENTS_INTO_MYSQL_EXTRA_VARS:
          TASKS_REPO: "https://github.com/open-craft/edx-analytics-pipeline.git"
          TASKS_BRANCH: "analytics-sandbox"
          CONFIG_REPO: "https://github.com/open-craft/edx-analytics-configuration.git"
          CONFIG_BRANCH: "analytics-sandbox"
          ENVIRONMENT: "analytics-sandbox"
          CLUSTER_NAME: "Analytics Sandbox: AnswerDistribution"
          EXTRA_VARS: "@/home/jenkins/emr-vars.yml" # src: "s3://custom_path"
          FROM_DATE: "2016-01-01"
          TASK_USER: "hadoop"
          NOTIFY: "staff@example.com"

#### Other Useful Variables

* `JENKINS_ANALYTICS_CONCURRENT_JOBS_COUNT`: Configures number of
  executors (or concurrent jobs this Jenkins instance can
  execute). Defaults to `2`.

### General Configuration

#### Jenkins Startup

Variables used by command waiting on Jenkins start-up after running
`jenkins_master` role:

    jenkins_connection_retries: 60
    jenkins_connection_delay: 0.5

#### Auth Realm

Jenkins auth realm, that is a method used by jenkins to authenticate users.
Realm type stored in `jenkins_auth_realm.name` variable.

In future we will try enable other auth domains, while
preserving ability to run cli.

##### Unix Realm

For now only `unix` realm supported -- which requires every user to have a
shell account on the server.

Unix realm requires following settings:

* `service`: Jenkins uses PAM configuration for this service. `su` is
a safe choice as it doesn't require a user to have the ability to login
remotely.
* `plain_password`:  plaintext password
* `hashed_password`: hashed password

Default realm configuration:

    jenkins_auth_realm:
      name: unix
      service: su
      plain_password: "{{ JENKINS_ANALYTICS_USER_PASSWORD_PLAIN }}"
      hashed_password: "{{ JENKINS_ANALYTICS_USER_PASSWORD_HASHED }}"


Known issues
------------

1. Playbook named `_execute_ansible_cli.yaml`, should be converted to a
   Ansible module (it is already used in a module-ish way),
2. Anonymous user has discover and get job permission, as without it
   `get-job`, `build <<job>>` commands wouldn't work.
   Giving anonymous these permissions is a workaround for
   transient Jenkins issue (reported [couple][1] [of][2] [times][3]).
3. We force unix authentication method -- that is every user that can login
   to Jenkins also needs to have a shell account on master.


Dependencies
------------

- `jenkins_master`

[1]: https://issues.jenkins-ci.org/browse/JENKINS-12543
[2]: https://issues.jenkins-ci.org/browse/JENKINS-11024
[3]: https://issues.jenkins-ci.org/browse/JENKINS-22143
