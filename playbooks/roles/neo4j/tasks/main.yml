---
#
# edX Configuration
#
# github:     https://github.com/edx/configuration
# wiki:       https://openedx.atlassian.net/wiki/display/OpenOPS
# code style: https://openedx.atlassian.net/wiki/display/OpenOPS/Ansible+Code+Conventions
# license:    https://github.com/edx/configuration/blob/master/LICENSE.TXT
#
#
#
# Tasks for role neo4j
#
# Overview:
#
#
# Dependencies:
#
#
# Example play:
#
#

- name: add neo4j gpg key
  apt_key:
    url: "{{ neo4j_gpg_key_url }}"
    state: present
  tags:
    - install
    - install:system-requirements

- name: add neo4j apt repository
  apt_repository:
    repo: "{{ neo4j_apt_repository }}"
    state: present
  tags:
    - install
    - install:system-requirements

- name: install neo4j
  apt:
    name: "neo4j={{neo4j_version}}"
    state: present
  tags:
    - install
    - install:base

- name: set neo4j heap size
  lineinfile:
    dest: "{{ neo4j_wrapper_config_file }}"
    regexp: "dbms.memory.heap.max_size="
    line: "dbms.memory.heap.max_size={{ neo4j_heap_max_size }}"
  tags:
    - install
    - install:configuration

- name: set to listen on specific port for https
  lineinfile:
    dest: "{{ neo4j_server_config_file }}"
    regexp: "{{ neo4j_https_settings_key }}="
    line: "{{ neo4j_https_settings_key }}={{ neo4j_listen_address }}:{{ neo4j_https_port }}"
  tags:
    - install
    - install:configuration

- name: set to listen on specific port for http
  lineinfile:
    dest: "{{ neo4j_server_config_file }}"
    regexp: "{{ neo4j_http_settings_key }}="
    line: "{{ neo4j_http_settings_key }}={{ neo4j_listen_address }}:{{ neo4j_http_port }}"
  tags:
    - install
    - install:configuration

- name: set to run neo4j with the newrelic javaagent
  # see https://docs.newrelic.com/docs/agents/java-agent/installation/java-agent-manual-installation
  lineinfile:
    dest: "{{ neo4j_server_config_file }}"
    regexp: "wrapper.java.additional.2="
    line: "wrapper.java.additional.2=/etc/neo4j/newrelic.jar"
  tags:
    - install
    - install:configuration

- name: store jar file for javaagent
  copy:
    src: newrelic.jar
    dest: /etc/neo4j
    # just guessing? No idea what mode we'd need
    mode: 0644
    owner: neo4j
  tags:
    - install
    - install:configuration

- template:
    src: ../templates/etc/neo4j/newrelic.yml.j2
    dest: /etc/neo4j/newrelic.yml
    owner: neo4j
    mode: 0644

- name: restart neo4j
  service:
    name: neo4j
    state: restarted
  tags:
    - manage
    - manage:start
