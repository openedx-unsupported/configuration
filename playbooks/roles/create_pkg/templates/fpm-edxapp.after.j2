#!/bin/bash

read -p "Configure <%= name %>? !! WARNING !! this will overwrite previous config changes [Y/n]: " reconfig
reconfig=${reconfig:-y}

if [[ $reconfig =~ ^[Yy] ]]; then

    read -p "Enter a mysql hostname for <%= name %> [localhost]: " db_host
    db_host=${db_host:-localhost}

    read -p "Enter a mysql port for <%= name %> [3306]: " db_port
    db_port=${db_port:-3306}

    read -p "Enter a mysql user for <%= name %> [root]: " db_user
    db_user=${db_user:-root}

    read -p "Enter a mysql password for <%= name %> [password]: " db_password
    db_password=${db_password:-password}

    read -p "Enter a mysql database for <%= name %> (will try to create if it doesn't exist) [edxapp]: " db_name
    db_name=${db_name:-edxapp}

    if ! mysql -u $db_user -p${db_password} -P $db_port -e "use ${db_name}" >/dev/null 2>&1; then
      mysql -u $db_user -p${db_password} -P $db_port -e "CREATE DATABASE ${db_name} DEFAULT CHARACTER SET utf8 DEFAULT COLLATE utf8_general_ci;"
    fi

    read -p "Enter mongo hosts for <%= name %> [localhost]: " mongo_hosts
    mongo_hosts=${mongo_hosts:-localhost}

    read -p "Enter a mongo port for <%= name %> [27017]: " mongo_port
    mongo_port=${mongo_port:-27017}

    read -p "Enter a mongo user for <%= name %> [root]: " mongo_user
    mongo_user=${mongo_user:-root}

    read -p "Enter a mongo password for <%= name %> [password]: " mongo_password
    mongo_password=${mongo_password:-password}

    read -p "Enter a mongo database for <%= name %> [edxapp]: " mongo_name
    mongo_name=${mongo_name:-edxapp}

    read -p "Enter memcache hosts for <%= name %>  [localhost:11211]: " memcache_hosts
    memcache_hosts=${memcache_hosts:-localhost:11211}


    cat << EXTRA_EOF >{{ COMMON_CFG_DIR }}/edxapp.cfg
# For now the LMS and the CMS share the same
# Database configuration 
export EDXAPP_MYSQL_PASSWORD=$db_password
export EDXAPP_MYSQL_USER=$db_user
export EDXAPP_MYSQL_DB_NAME=$db_name
export EDXAPP_MYSQL_HOST=$db_host
export EDXAPP_MYSQL_PORT=$db_port

export EDXAPP_MONGO_HOSTS=$mongo_hosts
export EDXAPP_MONGO_PASSWORD=$mongo_password
export EDXAPP_MONGO_USER=$mongo_user
export EDXAPP_MONGO_DB_NAME=$mongo_name
export EDXAPP_MONGO_PORT=$mongo_port

export DB_MIGRATION_PASS=$db_password
export DB_MIGRATION_USER=$db_user
export DB_MIGRATION_NAME=$db_name
export DB_MIGRATION_HOST=$db_host
export DB_MIGRATION_PORT=$db_port

export EDXAPP_MEMCACHE_HOSTS=$memcache_hosts

EXTRA_EOF

fi
ln -fs {{ COMMON_CFG_DIR }}/edxapp.cfg {{ COMMON_CFG_DIR }}/lms.cfg
ln -fs {{ COMMON_CFG_DIR }}/edxapp.cfg {{ COMMON_CFG_DIR }}/cms.cfg

echo "Running migrations"
cd {{ edxapp_code_dir }}
source {{ COMMON_CFG_DIR }}/lms.cfg
sudo -E -u edxapp {{ edxapp_venv_bin}}/python manage.py lms syncdb --migrate --noinput --settings=aws_env
source {{ COMMON_CFG_DIR }}/cms.cfg
sudo -E -u edxapp {{ edxapp_venv_bin}}/python manage.py cms syncdb --migrate --noinput --settings=aws_env

echo "Updating supervisor config"
{{ supervisor_ctl }} -c {{ supervisor_cfg }} update
echo "Restarting edxapp"
{{ supervisor_ctl }} -c {{ supervisor_cfg }} stop edxapp: >/dev/null
{{ supervisor_ctl }} -c {{ supervisor_cfg }} start edxapp:
