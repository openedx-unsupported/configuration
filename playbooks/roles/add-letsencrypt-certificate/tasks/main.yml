---

- name: Installing certbot dependencies
  apt: name="{{ item }}" update_cache=yes
  with_items: "{{ le_packages }}"
  become_method: sudo
  become: yes
  become_user: root

- name: Creating checkout directory for nginx
  file: path=/var/www/letsencrypt state=directory mode=0755 owner=www-data group=www-data
  become_method: sudo
  become: yes
  become_user: root
  notify: reload nginx

- name: Installing certbot
  get_url:
    url: https://dl.eff.org/certbot-auto
    dest: /usr/local/bin/certbot-auto
    mode: 0755
  become_method: sudo
  become: yes
  become_user: root

- name: Performing post-installation setup
  command: /usr/local/bin/certbot-auto --non-interactive --text --os-packages-only
  become_method: sudo
  become: yes
  become_user: root

- name: Requesting LMS and CMS certificate
  command: /usr/local/bin/certbot-auto certonly --agree-tos --non-interactive --text --rsa-key-size 2048 --webroot -w /var/www/letsencrypt -d "{{ EDXAPP_SITE_NAME }}" -d "{{ EDXAPP_CMS_SITE_NAME }}" -d "{{ EDXAPP_PREVIEW_LMS_BASE }}"  --register-unsafely-without-email --force-renewal
  become_method: sudo
  become: yes
  become_user: root

- name: Updating nginx LMS configuration
  template:
    src: "lms.j2"
    dest: "{{ nginx_sites_available_dir }}/lms"
    force: yes
  become_method: sudo
  become: yes
  become_user: root

- name: Updating nginx CMS configuration
  template:
    src: "cms.j2"
    dest: "{{ nginx_sites_available_dir }}/cms"
    force: yes
  become_method: sudo
  become: yes
  become_user: root

- name: Restarting nginx
  service: name=nginx state=restarted
  become_method: sudo
  become: yes
  become_user: root

- name: Add auto-renewal task in cron
  cron: 
    name: "Automatic renewal letsencrypt certificate" 
    minute: "0" 
    hour: "1"
    month: "*/2"
    job: '/usr/local/bin/certbot-auto renew --force-renewal --post-hook "service nginx restart" > /dev/null'
  become_method: sudo
  become: yes
  become_user: root

- name: Make sure nginx has started
  service:
    name: nginx
    state: started
  tags:
    - manage
    - manage:start
