---
#
# edX Configuration
#
# github:     https://github.com/edx/configuration
# wiki:       https://openedx.atlassian.net/wiki/display/OpenOPS
# code style: https://openedx.atlassian.net/wiki/display/OpenOPS/Ansible+Code+Conventions
# license:    https://github.com/edx/configuration/blob/master/LICENSE.TXT
#
#
#
# Tasks for role lets_encrupt
# 
# Overview:
# 
#
# Dependencies:
#
# 
# Example play:
#
#

- name: check domains
  fail:
    msg: "Domain list is empty"
  when: LETS_ENCRYPT_DOMAINS|length < 1
  tags:
    - install
    - update

- name: install certbot
  git:
    repo: https://github.com/certbot/certbot
    dest: /opt/certbot
  tags:
   - install

- name: create .well-known directory
  file:
    path: /usr/share/nginx/www/.well-known
    state: directory
    owner: www-data
    group: www-data
  tags:
    - install
    - update
    
- name: render certbot script
  template:
    src: run_certbot.sh.j2
    dest: /tmp/run_certbot.sh
    mode: u+x
  tags:
    - install
    - update

- name: run certbot
  command: /tmp/run_certbot.sh
  tags:
    - install
    - update

# Create symlinks to the letsencrypt certificates into
# the main cert folder. When requesting multi-domain
# certs they are shared: symlink only required to the first

- name: symlink certificates
  file: >
    src=/etc/letsencrypt/live/{{ LETS_ENCRYPT_DOMAINS|first }}/{{ item.src }}
    dest=/etc/ssl/{{ item.dest }} 
    state=link
  with_items:
    - { src: 'fullchain.pem', dest: 'certs/fullchain.pem' }
    - { src: 'privkey.pem',  dest: 'private/privkey.pem' }
  tags:
    - install

- name: replace nginx cert configuration file
  template:
    src: ssl-certs.conf.j2
    dest: /etc/nginx/ssl-certs.conf
    owner: root
  tags:
    - install
    - install:configuration

# Renewal will auto-update the certs in place at the linked-to locations
# checks twice daily @ 6hrÂ±60mins
- name: create monthly auto-renew cron job
  cron: 
        name      : "Renew Let's Encrypt certificates via certbot"
        hour      : 0,12
        cron_file : "lets-encrypt-renew"
        user      : "root"
        job       : sleep $[RANDOM\%60]m; /opt/certbot/certbot-auto renew
        state     : present
  tags:
    - install
    - install:cron

- name: reload nginx config
  service:
    name: nginx
    state: reloaded
  tags:
    - install
    - update
