# Launches an ec2 instance and blocks until the instance is up
# adds it to the host group 

- name: launch_ec2 | Launch ec2 instance 
  local_action: 
    module: ec2 
    keypair: "{{ keypair }}"
    group: "{{ security_group }}"
    instance_type: "{{ instance_type }}"
    image: "{{ ami }}"
    wait: true 
    region: "{{ region }}"
    instance_tags: "{{instance_tags}}"
    size: "{{ size }}"
  register: ec2

- name: launch_ec2 | Add DNS name
  local_action:
    module: route53
    command: create
    zone: sandbox.edx.org
    type: CNAME
    ttl: 300
    record: "{{ dns_name }}.{{ dns_zone }}"
    value: "{{ item.public_dns_name }}"
  with_items: "{{ ec2.instances }}"

- name: launch_ec2 | Add DNS name studio
  local_action:
    module: route53
    command: create
    zone: sandbox.edx.org
    type: CNAME
    ttl: 300
    record: "studio.{{ dns_name }}.{{ dns_zone }}"
    value: "{{ item.public_dns_name }}"
  with_items: "{{ ec2.instances }}"

- name: launch_ec2 | Add DNS name preview
  local_action:
    module: route53
    command: create
    zone: "{{ dns_zone }}"
    type: CNAME
    ttl: 300
    record: "preview.{{ dns_name }}.{{ dns_zone }}"
    value: "{{ item.public_dns_name }}"
  with_items: "{{ ec2.instances }}"




- name: launch_ec2 | Add new instance to host group
  local_action: >
    add_host 
      hostname={{ item.public_ip }} 
      groupname=launched 
  with_items: "{{ ec2.instances }}"

- name: launch_ec2 | Wait for SSH to come up
  local_action: >
    wait_for 
      host={{ item.public_dns_name }}
      state=started
      port=22 
      delay=60 
      timeout=320
  with_items: "{{ ec2.instances }}"
