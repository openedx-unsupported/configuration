---
# The deadsnakes PPA is required to install python3.5 on Trusty.
# Xenial comes with python3.5 installed.
- name: add deadsnakes repository
  apt_repository:
    repo: "ppa:deadsnakes/ppa"
  when: ansible_distribution_release == 'bionic'
  tags:
    - install
    - install:system-requirements

- name: install python3.5, 3.6 and 3.8
  apt:
    name: "{{ item }}"
  with_items:
    - python3.5
    - python3.5-dev
    - python3.6
    - python3.6-dev
    - python3.8
    - python3.8-dev
  when: ansible_distribution_release == 'bionic'
  tags:
    - install
    - install:system-requirements

- name: download the Cloudwatch agent package
  get_url:
    dest: /tmp/{{ item.name }}
    url: "{{ item.url }}"
  register: download_deb
  until: download_deb is succeeded
  retries: 5
  with_items: "{{ cloudwatch_agent_s3_deb_pkgs }}"
  when: ansible_distribution_release == 'xenial' or ansible_distribution_release == 'bionic'
  tags:
    - install
    - install:system-requirements

- name: install xenial/bionic Cloudwatch agent packages
  shell: gdebi -nq /tmp/{{ item.name }}
  with_items: "{{ cloudwatch_agent_s3_deb_pkgs }}"
  when: download_deb.changed and
        ansible_distribution_release == 'xenial' or ansible_distribution_release == 'bionic'
  tags:
    - install
    - install:system-requirements

- name: download Cloudagent configuration package from S3
  get_url:
    dest: /opt/aws/amazon-cloudwatch-agent/bin/{{ item.name }}
    url: "{{ item.url }}"
  register: download_configuration_file
  with_items: "{{ cloudwatch_agent_config }}"
  when: ansible_distribution_release == 'xenial' or ansible_distribution_release == 'bionic'
  tags:
    - install
    - install:system-requirements

- name: Add the cwagent user to adm group
  user:
    name: '{{ cwagent_user }}'
    groups:  '{{ cwagent_group }}'
    append: yes
    shell: /bin/bash
  tags:
    - install
    - install:system-requirements

- name: reload cloudwatch agent configuration
  command: /opt/aws/amazon-cloudwatch-agent/bin/amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -c file:/opt/aws/amazon-cloudwatch-agent/bin/{{ item.name  }} -s
  with_items: "{{ cloudwatch_agent_config }}"
  tags:
    - install
    - install:system-requirements

- name: restart cloudwatch agent
  command: systemctl restart amazon-cloudwatch-agent.service
  tags:
    - install
    - install:system-requirements
