# requires:
#  - group_vars/all
#  - common/tasks/main.yml
#  - nginx/tasks/main.yml
---
- name: ora | Change permissions on datadir
  file: path={{ora_code_dir}}/../data state=directory owner=www-data group=www-data
  tags:
  - ora

- name: ora | Create ml_models directory
  file: path={{ora_code_dir}}/../ml_models state=directory owner=www-data group=www-data
  tags:
  - ora

# Check out ora repo to {{ora_code_dir}}
- name: ora | install git and its recommends
  apt: pkg=git state=present install_recommends=yes
  tags:
  - ora

- name: ora | create ora application config
  template: src=ora.env.json.j2 dest={{ora_code_dir}}/../env.json mode=0640 owner=www-data group=adm
  tags:
  - ora

- name: ora | create ora auth file
  template: src=ora.auth.json.j2 dest={{ora_code_dir}}/../auth.json mode=0640 owner=www-data group=adm
  tags:
  - ora

- name: ora | create ora upstart script
  template: src=edx-ora.conf.j2 dest=/etc/init/edx-ora.conf mode=0640 owner=root group=adm
  tags:
  - ora

- name: ora | create ora-celery upstart script
  template: src=edx-ora-celery.conf.j2 dest=/etc/init/edx-ora-celery.conf mode=0640 owner=root group=adm
  tags:
  - ora

- name: ora | install debian packages that ora needs
  apt: pkg={{item}} state=present
  with_items: ora_debian_pkgs
  tags:
  - ora

- name: ora | create the ora virtual environment
  file: path={{ ora_venv_dir }} owner=root group=adm mode=2775 state=directory
  tags:
  - ora

- name: ora | bootstrap the ora virtual environment
  command: /usr/local/bin/virtualenv {{ ora_venv_dir }} --distribute creates={{ora_venv_dir}}/bin/activate
  tags:
  - ora

# Install nginx site
- include: ../../nginx/tasks/nginx_site.yml state=link site_name=ora

- include: ease.yml
- include: deploy.yml
