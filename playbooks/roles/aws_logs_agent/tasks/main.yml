---
- name: Download the Cloudwatch agent package
  get_url:
    dest: /tmp/{{ item.name }}
    url: "{{ item.url }}"
  register: download_deb
  until: download_deb is succeeded
  retries: 5
  with_items: "{{ cloudwatch_agent_s3_deb_pkgs }}"

- name: Install Cloudwatch agent packages
  shell: dpkg -i -E /tmp/{{ item.name }}
  with_items: "{{ cloudwatch_agent_s3_deb_pkgs }}"
  become: yes

- name: Copy aws_logs_agent.json template
  template:
    src: "aws_logs_agent.json.j2"
    dest: "/opt/aws/amazon-cloudwatch-agent/etc/aws_logs_agent.json"
    mode: "0664"
  become: yes

- name: Start cloudwatch agent
  command: amazon-cloudwatch-agent-ctl -a fetch-config -m ec2 -s -c file:/opt/aws/amazon-cloudwatch-agent/etc/aws_logs_agent.json
  become: yes
