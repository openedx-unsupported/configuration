---
#
# edX Configuration
#
# github:     https://github.com/edx/configuration
# wiki:       https://openedx.atlassian.net/wiki/display/OpenOPS
# code style: https://openedx.atlassian.net/wiki/display/OpenOPS/Ansible+Code+Conventions
# license:    https://github.com/edx/configuration/blob/master/LICENSE.TXT
#
#
#
# Tasks for role splunk-server
# 
# Overview:
# 
#
# Dependencies:
#
# 
# Example play:
#
#


- name: Create bucket directories
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ splunk_user  }}"
    group: "{{ splunk_user }}"
  with_items:
    - "{{ splunk_hot_dir }}"
    - "{{ splunk_thawed_dir }}"
    - "{{ splunk_cold_dir }}"
    - "{{ splunk_frozen_dir }}"
  tags:
    - "install"
    - "install:configuration"

- name: Create configuration directory
  file:
    path: "{{ item }}"
    state: directory
    owner: "{{ splunk_user  }}"
    group: "{{ splunk_user }}"
  with_items:
    - "/opt/splunk/etc/apps/search/local"
  tags:
    - "install"
    - "install:configuration"

- name: configure splunk buckets
  template:
    src: "opt/splunk/etc/apps/search/local/indexes.conf.j2"
    dest: "/opt/splunk/etc/apps/search/local/indexes.conf"
    owner: "{{ splunk_user }}"
    group: "{{ splunk_user }}"
    mode: 0700
  tags:
    - "install"
    - "install:configuration"

- name: configure splunk searches
  template:
    src: "opt/splunk/etc/apps/search/local/savedsearches.conf.j2"
    dest: "/opt/splunk/etc/apps/search/local/savedsearches.conf"
    owner: "{{ splunk_user }}"
    group: "{{ splunk_user }}"
    mode: 0700
  tags:
    - "install"
    - "install:configuration"
  when:
    SPLUNK_ALERTS is defined

- name: restart splunk
  service: 
    name: splunk
    state: restarted 
  tags:
    - "install"
    - "install:configuration"
    - "restart"

