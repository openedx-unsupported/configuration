#!/usr/bin/env bash
set -e

###############################################################################
#
#   edx-acceptance.sh
#
#   Execute acceptance tests for edx-platform.
#
#   This script can be called from a Jenkins
#   job that defines these environment variables:
#
#   `TEST_SUITE` defines which acceptance test suite to run
#   Possible values are:
#
#       - "lms": Run the acceptance (Selenium) tests for the LMS
#       - "cms": Run the acceptance (Selenium) tests for Studio
#
#   `FEATURE_PATH` is the path to the lettuce .feature file
#       containing the tests to run.  If empty, run all the tests.
#
#   Other assumptions:
#
#   - The edx-platform git repository is checked out by the Jenkins git plugin.
#
#   - Jenkins logs in as {{ jenkins_user }}
#
#   - The Jenkins slave file system root {{ jenkins_home }}
#
###############################################################################

source {{ jenkins_home }}/jenkins_env

# Clean up previous builds
git clean -qxfd

# Clear the mongo database
# Note that this prevents us from running jobs in parallel on a single worker.
mongo --quiet --eval 'db.getMongo().getDBNames().forEach(function(i){db.getSiblingDB(i).dropDatabase()})'

# Create and activate the Python virtualenv
{{ jenkins_home }}/wheel_venv.sh {{ jenkins_home }}/edx-venv
source {{ jenkins_home }}/edx-venv/bin/activate

rake test:acceptance:${TEST_SUITE}["-v 3 ${FEATURE_PATH}"]
