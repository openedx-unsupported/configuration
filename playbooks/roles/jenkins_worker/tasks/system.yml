---
- name: Create jenkins group
  group: name={{ jenkins_group }} state=present

# The Jenkins account needs a login shell because Jenkins uses scp
- name: Add the jenkins user to the group and configure shell
  user: name={{ jenkins_user }} append=yes group={{ jenkins_group }} shell=/bin/bash

# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: Create .ssh directory
  file:
    path={{ jenkins_home }}/.ssh state=directory
    owner={{ jenkins_user }} group={{ jenkins_group }}
  ignore_errors: yes

- name: Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys
  ignore_errors: yes

- name: Set key permissions
  file:
    path={{ jenkins_home }}/.ssh/authorized_keys
    owner={{ jenkins_user }} group={{ jenkins_group }} mode=400
  ignore_errors: yes

# adding chris-lea nodejs repo
- name: add ppas for current versions of nodejs
  apt_repository: repo="{{ jenkins_chrislea_ppa }}"

- name: Install system packages
  apt: pkg={{','.join(jenkins_debian_pkgs)}}
       state=present update_cache=yes

- name: Add script to set up environment variables
  template:
    src=jenkins_env.j2 dest={{ jenkins_home }}/jenkins_env
    owner={{ jenkins_user }} group={{ jenkins_group }} mode=0500

# Need to add Github to known_hosts to avoid
# being prompted when using git through ssh
- name: Add github.com to known_hosts if it does not exist
  shell: >
     ssh-keygen -f {{ jenkins_home }}/.ssh/known_hosts -H -F github.com | grep -q found || ssh-keyscan -H github.com > {{ jenkins_home }}/.ssh/known_hosts

- name: Configure /etc/hosts for the Preview button to work in Studio
  template: src=hosts.j2 dest=/etc/hosts
