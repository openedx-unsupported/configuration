---
- name: jenkins_worker | Create jenkins group
  group: name={{ jenkins_group }} state=present

- name: jenkins_worker | Add the jenkins user to the group
  user: name={{ jenkins_user }} append=yes group={{ jenkins_group }}


# We need the upstart script to create the build directory
# so that (a) it will be run when a new instance is created
# on the current EBS, and (b) it will be run as root.
- name: jenkins_worker | Install upstart script to create build dir
  template: src=jenkins_workspace.conf.j2
    dest=/etc/init/jenkins_workspace.conf
    owner=root group=root


# Because of a bug in the latest release of the EC2 plugin
# we need to use a key generated by Amazon (not imported)
# To satisfy this, we allow users to log in as Jenkins
# using the same keypair the instance was started with.
- name: jenkins_worker | Create .ssh directory
  file: path={{ jenkins_user_home }}/.ssh state=directory
        owner={{ jenkins_user }} group={{ jenkins_group }}

- name: jenkins_worker | Copy ssh keys for jenkins
  command: cp /home/ubuntu/.ssh/authorized_keys /home/{{ jenkins_user }}/.ssh/authorized_keys

- name: jenkins_worker | Set key permissions
  file: path={{ jenkins_user_home }}/.ssh/authorized_keys
        owner={{ jenkins_user }} group={{ jenkins_group }}
        mode=400

# Ensure that we get a current version of Git
# GitHub requires version 1.7.10 or later
# https://help.github.com/articles/https-cloning-errors
- name: jenkins_worker | Add git apt repository
  apt_repository: repo='ppa:git-core/ppa'

- name: jenkins_worker | Install system packages
  apt: pkg={{','.join(jenkins_debian_pkgs)}}
       state=present update_cache=yes

- name: jenkins_worker | Add script to set up environment variables
  template: src=jenkins_env.sh.j2 dest=/usr/local/bin/jenkins_env.sh
            owner=root group=root mode=0555

# Need to add Github to known_hosts to avoid
# being prompted when using git through ssh
- name: jenkins_worker | Add github.com to known_hosts if it does not exist
  shell: >
     ssh-keygen -f {{ jenkins_user_home }}/.ssh/known_hosts -H -F github.com | grep -q found || ssh-keyscan -H github.com > {{ jenkins_user_home }}/.ssh/known_hosts
