# requires:
#  - group_vars/all
#  - common/tasks/main.yml
---
# Check out xqueue repo to {{xqueue_code_dir}}
#
#

- name: create application user
  user: >
    name="{{ xqueue_user }}"
    home="{{ xqueue_app_dir }}"
    createhome=no
    shell=/bin/false
  notify:
    - restart xqueue

- name: create xqueue app and venv dir
  file: >
    path="{{ item }}"
    state=directory
    owner="{{ xqueue_user }}"
    group="{{ common_web_group }}"
  notify:
    - restart xqueue
  with_items:
    - "{{ xqueue_app_dir }}"
    - "{{ xqueue_venvs_dir }}"

- name: install a bunch of system packages on which xqueue relies
  apt: pkg={{','.join(xqueue_debian_pkgs)}} state=present
  notify:
  - restart xqueue

- include: deploy.yml tags=deploy


- name: setup the xqueue env
  template: >
    src=xqueue_env.j2 dest={{ xqueue_app_dir }}/xqueue_env
    owner={{ xqueue_user }}  group={{ common_web_user }}
    mode=0644
  notify:
    - restart xqueue

- name: create the supervisor wrapper for xqueue
  template: >
    src={{ xqueue_supervisor_wrapper|basename }}.j2
    dest={{ xqueue_supervisor_wrapper }}
    mode=0755
  sudo_user: "{{ xqueue_user }}"
  notify: restart xqueue

- name: create the supervisor wrapper for xqueue-consumer
  template: >
    src={{ xqueue_consumer_supervisor_wrapper|basename }}.j2
    dest={{ xqueue_consumer_supervisor_wrapper }}
    mode=0755
  sudo_user: "{{ xqueue_user }}"
  notify: restart xqueue


