# Provision and bring up xserver
# As of right now this role requires
# access to the edX 6.00x repo which is not public
---

- name: xserver | ensure sandbox group exists
  group: name=sandbox

- name: xserver | ensure sandbox user exists
  user: name=sandbox group=sandbox

- name: xserver | create sandbox python directory
  file: path={{ xserver_sandbox_venv_dir }} owner=ubuntu group=adm mode=2775 state=directory

- name: xserver | create sandbox sudoers file
  template: src=99-sandbox.j2 dest=/etc/sudoers.d/99-sandbox owner=root group=root mode=0440

- name: xserver | create sandbox python
  command: /usr/local/bin/virtualenv {{ xserver_sandbox_venv_dir }} --distribute creates={{ xserver_sandbox_venv_dir }}/bin/activate

# Make sure this line is in the common-session file.
- name: xserver | ensure pam-limits module is loaded
  lineinfile:
    dest=/etc/pam.d/common-session
    regexp="session required pam_limits.so"
    line="session required pam_limits.so"

- name: xserver | set sandbox limits
  copy: src={{ item }} dest=/etc/security/limits.d/sandbox.conf
  first_available_file:
  - "{{ secure_dir }}/sandbox.conf"
  - "sandbox.conf"

- name: xserver | ensure apparmor package
  apt: pkg=apparmor-utils state=present

- name: xserver | load python-sandbox apparmor profile
  template: src={{ item }} dest=/etc/apparmor.d/edx_apparmor_sandbox
  first_available_file:
  - "{{ secure_dir }}/files/edx_apparmor_sandbox.j2"
  - "usr.bin.python-sandbox.j2"

- name: xserver | enforce app-armor rules
  command: aa-enforce {{ xserver_sandbox_venv_dir }}

- name: xserver | setup upstart script
  template: src=xserver.conf.j2 dest=/etc/init/xserver.conf owner=root group=root

- name: xserver | install system dependencies of xserver
  apt: pkg={{ item }} state=present
  with_items: xserver_debian_pkgs

- name: xserver | upload ssh script
  copy: src=git_ssh.sh dest=/tmp/git_ssh.sh force=yes owner=root group=adm mode=750

- include: nginx.yml

- include: deploy.yml
