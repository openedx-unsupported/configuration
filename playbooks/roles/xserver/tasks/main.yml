# Provision and bring up xserver
---

- name: ensure sandbox group exists
  group: name=sandbox

- name: ensure sandbox user exists
  user: name=sandbox group=sandbox

- name: create sandbox python directory
  file: path={{ sandbox_venv_dir }} owner=ubuntu group=adm mode=2775 state=directory

- name: create sandbox python
  command: /usr/local/bin/virtualenv {{ sandbox_venv_dir }} --distribute creates={{ sandbox_venv_dir }}/bin/activate

- name: set sandbox sudoers settings
  copy: src=sandbox.sudoers dest=/etc/sudoers.d/99-sandbox

# Make sure this line is in the common-session file.
- name: ensure pam-limits module is loaded
  lineinfile:
    dest=/etc/pam.d/common-session
    regexp="session required pam_limits.so"
    line="session required pam_limits.so"

- name: set sandbox limits
  copy: src={{ item }} dest=/etc/security/limits.d/sandbox.conf
  first_available_file:
  - "{{ secure_dir }}/sandbox.conf"
  - "sandbox.conf"

- name: ensure apparmor package
  apt: pkg=apparmor-utils state=present

- name: load python-sandbox apparmor profile
  template: src={{ item }} dest=/etc/apparmor.d/edx_apparmor_sandbox
  first_available_file:
  - "{{ secure_dir }}/files/edx_apparmor_sandbox.j2"
  - "usr.bin.python-sandbox.j2"

- name: enforce app-armor rules
  command: aa-enforce {{ sandbox_venv_dir }}

- name: setup upstart script
  template: src=xserver.conf.j2 dest=/etc/init/xserver.conf owner=root group=root

- include: deploy.yml
