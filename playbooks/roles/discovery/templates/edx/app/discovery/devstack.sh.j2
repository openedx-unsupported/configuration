#!/usr/bin/env bash

# {{ ansible_managed }}

source {{ discovery_home }}/discovery_env
COMMAND=$1

case $COMMAND in
    start)
        {% set discovery_venv_bin = discovery_venv_dir + "/bin" %}

        {{ supervisor_venv_bin }}/supervisord --configuration {{ supervisor_cfg }}

        # Needed to run bower as root. See explanation around 'discovery_user=root'
        echo '{ "allow_root": true }' > /root/.bowerrc

        cd /edx/app/edx_ansible/edx_ansible/docker/plays
        /edx/app/edx_ansible/venvs/edx_ansible/bin/ansible-playbook discovery.yml -c local -i '127.0.0.1,' \
            -t 'manage:start' \
            --extra-vars="@/ansible_overrides.yml"

        # Docker requires an active foreground task. Tail the logs to appease Docker and
        # provide useful output for development.
        cd {{ supervisor_log_dir }}
        tail -f {{ discovery_service_name }}-stderr.log -f {{ discovery_service_name }}-stdout.log

        ;;
    open)
        cd {{ discovery_code_dir }}
        . {{ discovery_venv_bin }}/activate
        /bin/bash
        ;;
esac
