---
- name: Create jenkins config sub folders
  file:
    path: '{{ item }}'
    state: directory
    owner: '{{ build_jenkins_user }}'
  with_items:
    - '{{ build_jenkins_config_path }}/credentials'
    - '{{ build_jenkins_config_path }}/ec2'
    - '{{ build_jenkins_config_path }}/xml'
  tags:
     - install
     - install:base

- name: Copy j2 files
  template:
    src: '{{ role_path }}/templates/{{ item }}.yml.j2'
    dest: '{{ build_jenkins_config_path }}/{{ item }}.yml'
  with_items:
    - credentials
    - security
    - ghprb_config
    - ec2_config
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Copy non plugins.yml config files
  template: src={{ item }} dest='{{ build_jenkins_config_path }}/'
  with_fileglob:
    - '{{ role_path }}/files/*'
  when: "'plugins.yml' not in item"
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Copy plugins.yml config file
  template: src='{{ role_path }}/files/plugins.yml' dest='{{ build_jenkins_config_path }}/'
  tags:
    - install
    - install:base
    - install:plugins
    - install:jenkins-configuration

- name: Copy ec2 config files
  template: src={{ item }} dest='{{ build_jenkins_config_path }}/ec2/'
  with_fileglob:
    - '{{ role_path }}/files/ec2/*'
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Copy xml config files
  template: src={{ item }} dest='{{ build_jenkins_config_path }}/xml/'
  with_fileglob:
    - '{{ role_path }}/files/xml/*'
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Run plugins.gradle
  shell: './gradlew -b plugins.gradle plugins'
  args:
    chdir: '{{ build_jenkins_git_home }}/jenkins-configuration'
  environment:
    PLUGIN_OUTPUT_DIR: '{{ build_jenkins_home }}/plugins'
    PLUGIN_CONFIG: '{{ build_jenkins_config_path }}/plugins.yml'
  tags:
    - install
    - install:base
    - install:plugins
    - install:jenkins-configuration

- name: Copy credentials into files
  copy:
    content: "{{ item.content }}"
    dest: '{{ build_jenkins_config_path }}/credentials/{{ item.name }}'
  with_items: '{{ JENKINS_SECRET_FILES_LIST }}'
  no_log: yes
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Copy ec2 key
  copy:
    content: '{{ JENKINS_EC2_PRIVATE_KEY }}'
    dest: '{{ build_jenkins_config_path }}/ec2/id_rsa'
  no_log: yes
  tags:
    - install
    - install:base
    - install:jenkins-configuration

- name: Start Jenkins Service
  systemd:
    name: jenkins
    daemon_reload: yes
    state: restarted
  tags:
    - manage
    - manage:start
    - install:plugins
    - install:jenkins-configuration
